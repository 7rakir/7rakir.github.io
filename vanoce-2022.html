<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Demo - The Web's Sixth Sense: A Study of Scripts Accessing Smartphone Sensors</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <title>JavaScript Sensor Access Demo</title>
  <style>
    body {
      margin: 0;
    }

    main {
      display: flex;
      flex-direction: column;
      margin: 1rem;
    }

    .orientation-group {
      display: inline-flex;
      flex-direction: row;
      justify-content: center;
    }

    .orientation {
      flex-grow: 1;
      text-align: center;
      font-size: 8vw;
      margin: 0 2vw;
    }
  </style>
</head>

<body>
  <main role="main">
    <div class="orientation-group" id="demo-div">
      <div class="orientation"><span id="Orientation_b">-180.0</span><span>&deg;</span></div>
      <div class="orientation"><span id="Orientation_g">-180.0</span><span>&deg;</span></div>
      <div class="orientation"><span id="Orientation_a">-180.0</span><span>&deg;</span></div>
    </div>

    <a id="start_demo" class="btn btn-lg btn-success py-1" href="#" role="button">Start</a>

    <input id="alpha" oninput="inputChange()" value="0" />
    <input id="beta" oninput="inputChange()" value="0" />
    <input id="gamma" oninput="inputChange()" value="0" />
  </main>

  <script>

    function handleOrientation(event) {
      var transformedAlpha = event.alpha - 180; // 0 - 360
      updateFieldIfNotNull('Orientation_a', transformedAlpha); // -180 - 180
      updateFieldIfNotNull('Orientation_b', event.beta); // -180 - 180
      updateFieldIfNotNull('Orientation_g', event.gamma); // -90 - 90

      applyChange(transformedAlpha, event.beta, event.gamma);
    }

    function updateFieldIfNotNull(fieldName, value, precision = 1) {
      if (value != null)
        document.getElementById(fieldName).innerHTML = value.toFixed(precision);
    }

    let demo_button = document.getElementById("start_demo");

    let noiseGain;
    let audio;

    function inputChange(value) {
      var alpha = document.getElementById('alpha').value;
      var beta = document.getElementById('beta').value;
      var gamma = document.getElementById('gamma').value;
      applyChange(parseFloat(alpha), parseFloat(beta), parseFloat(gamma));
    }

    function applyChange(alpha, beta, gama) {
      var absoluteSum = Math.abs(alpha) + Math.abs(beta) + Math.abs(gama);
      var shrinkage = 1.0 / 2;
      var volume = 1 - (shrinkage / (shrinkage + absoluteSum))
      updateVolume(volume);
    }

    function updateVolume(value) { // 0 - 1
      noiseGain.gain.value = value;
      audio.volume = 1 - value;
    }

    function createNoise(audioContext) {
      // Create an empty buffer
      const noiseBuffer = new AudioBuffer({
        length: audioContext.sampleRate * 2,
        sampleRate: audioContext.sampleRate
      });

      // Fill the buffer with noise
      for (let channel = 0; channel < noiseBuffer.numberOfChannels; channel++) {
        const noiseData = noiseBuffer.getChannelData(channel);
        for (let i = 0; i < noiseData.length; i++) {
          noiseData[i] = (Math.random() * 2 - 1) * 3;
        }
      }

      // Create a buffer source for our created data
      return new AudioBufferSourceNode(audioContext, {
        buffer: noiseBuffer,
        loop: true
      });
    }

    function createAudio() {
      var audio = new Audio();
      audio.controls = true;
      audio.loop = true;
      audio.crossOrigin = "anonymous";
      audio.src = ".\\ttsMP3.com_VoiceText_2022-12-3_13_21_39.mp3";
      document.getElementById('demo-div').appendChild(audio);
      audio.autoplay = true;
      return audio;
    }

    demo_button.onclick = function (e) {
      e.preventDefault();

      //////////////////

      audio = createAudio();

      const audioContext = new AudioContext();
      var filter = createNoise(audioContext);

      noiseGain = audioContext.createGain();

      const bandpass = new BiquadFilterNode(audioContext, {
        type: "bandpass",
        frequency: 200
      });

      filter.connect(bandpass).connect(noiseGain);
      noiseGain.connect(audioContext.destination);
      filter.start();

      ///////////////////////

      // Request permission for iOS 13+ devices
      if (
        DeviceMotionEvent &&
        typeof DeviceMotionEvent.requestPermission === "function"
      ) {
        DeviceMotionEvent.requestPermission();
      }

      window.addEventListener("deviceorientation", handleOrientation);
      demo_button.remove();
    };

  </script>
</body>

</html>